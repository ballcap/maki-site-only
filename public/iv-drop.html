<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>点滴管理ツール</title>

<style>
/* ---- SAME STYLES (unchanged) ---- */
:root{--bg:#f2f4f7;--card:#fff;--primary:#4a90e2;--danger:#e25b5b}
body{font-family:"Hiragino Maru Gothic ProN","Yu Gothic",sans-serif;background:var(--bg);padding:12px;margin:0;color:#222}
h2{text-align:center;font-size:20px;margin:12px 0}
input,select,button,textarea{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #ccc;box-sizing:border-box;font-size:15px}
button{background:var(--primary);color:#fff;border:0;font-weight:700;border-radius:10px;padding:10px}
button.small{padding:6px 8px;font-size:13px;border-radius:8px}
button.warn{background:#ffcccb;color:#800}
.card{background:var(--card);padding:14px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.06);margin-bottom:18px}
.list-table{width:100%;border-collapse:collapse;margin-bottom:20px}
.list-table th,.list-table td{border:1px solid #ccc;padding:8px;text-align:left}
.list-table th{background:#e9ecef}
.name-cell{color:#0d6efd;font-weight:700;cursor:pointer;text-decoration:underline}
.patient-record{background:#fff;border-radius:12px;padding:12px;margin-bottom:12px;box-shadow:0 4px 12px rgba(0,0,0,0.06)}
</style>
</head>

<body>
<h2>点滴管理ツール</h2>

<div class="card">
  <label>患者ID</label>
  <input id="pid">

  <label>患者名</label>
  <input id="pname">

  <label>施設</label>
  <select id="facility">
    <option value="">なし</option>
    <option>くぬぎ</option>
    <option>みさき</option>
    <option>たかねG</option>
    <option>たかね特</option>
    <option>つぼい</option>
  </select>

  <label>開始日</label>
  <input type="date" id="startdate">

  <label>日数</label>
  <input type="number" id="days" value="1">

  <label>備考</label>
  <textarea id="note"></textarea>

  <button onclick="save()">追加</button>
</div>

<h2>患者一覧</h2>
<table class="list-table">
<thead>
<tr><th>ID</th><th>名前</th><th>施設</th><th>期間</th><th>操作</th></tr>
</thead>
<tbody id="list"></tbody>
</table>

<h2 id="histTitle" style="display:none">履歴</h2>
<div id="history"></div>

<script>
/* ===========================
   PostgreSQL-backed version
   =========================== */

let patients = {};

/* ---------- Utilities ---------- */
function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g,c=>({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[c]));
}

/* ---------- Load patients ---------- */
async function loadPatients(){
  const res = await fetch("/injection/all");
  const rows = await res.json();

  patients = {};
  rows.forEach(r=>{
    if(!patients[r.patientid]){
      patients[r.patientid] = { name:r.name, records:[] };
    }
    patients[r.patientid].records.push(r);
  });

  renderList();
}

/* ---------- Save ---------- */
async function save(){
  const id = pid.value.trim();
  if(!id){ alert("ID required"); return; }

  const record = {
    facility: facility.value,
    start: startdate.value,
    end: startdate.value,
    note: note.value
  };

  await fetch("/injection/add",{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({
      id,
      name: pname.value,
      record
    })
  });

  await loadPatients();
  reset();
}

/* ---------- Render list ---------- */
function renderList(){
  list.innerHTML = "";
  for(const id in patients){
    const p = patients[id];
    const last = p.records[p.records.length-1];
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${id}</td>
      <td class="name-cell" onclick="showHistory('${id}')">${escapeHtml(p.name)}</td>
      <td>${escapeHtml(last.facility||"-")}</td>
      <td>${escapeHtml(last.startdate||"-")}</td>
      <td>
        <button class="small warn" onclick="deletePatient('${id}')">削除</button>
      </td>
    `;
    list.appendChild(tr);
  }
}

/* ---------- History ---------- */
async function showHistory(id){
  histTitle.style.display = "block";
  history.innerHTML = "";

  const res = await fetch(`/injection/history/${id}`);
  const rows = await res.json();

  rows.forEach(r=>{
    const div = document.createElement("div");
    div.className = "patient-record";
    div.innerHTML = `
      <b>施設:</b> ${escapeHtml(r.facility||"-")}<br>
      <b>開始:</b> ${escapeHtml(r.startdate||"-")}<br>
      <b>備考:</b> ${escapeHtml(r.note||"-")}<br>
      <button class="small warn" onclick="deleteRecord(${r.recordid},'${id}')">削除</button>
    `;
    history.appendChild(div);
  });
}

/* ---------- Delete ---------- */
async function deletePatient(id){
  if(!confirm("削除しますか？")) return;
  await fetch(`/injection/patient/${id}`,{method:"DELETE"});
  histTitle.style.display="none";
  history.innerHTML="";
  loadPatients();
}

async function deleteRecord(rid,id){
  if(!confirm("履歴を削除しますか？")) return;
  await fetch(`/injection/record/${rid}`,{method:"DELETE"});
  showHistory(id);
  loadPatients();
}

/* ---------- Reset ---------- */
function reset(){
  pid.value="";
  pname.value="";
  facility.value="";
  startdate.value="";
  days.value=1;
  note.value="";
}

/* ---------- Init ---------- */
loadPatients();
</script>
</body>
</html>
